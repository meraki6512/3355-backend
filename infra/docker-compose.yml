# docker-compose.yml (root)
# local dev/test용
version: '3.8'

# Docker 네트워크 정의
networks:
  zonie-net:
    driver: bridge

services:
  # --- 1. Database (PostgreSQL) ---
  postgres_db:
    image: postgis/postgis:16-3.4-alpine
    container_name: zonie_postgres_db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=zonie_main
      - POSTGRES_USER=zonie
      - POSTGRES_PASSWORD=zonie_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - zonie-net

  # --- 2. Cache (Redis) ---
  redis_cache:
    image: redis:7-alpine
    container_name: zonie_redis_cache
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - zonie-net

  # --- 3. Chat DB (MongoDB) ---
  mongo_db:
    image: mongo:7.0
    container_name: zonie_mongo_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: |
        mongosh --eval 'try { rs.status().ok } catch (e) { db.adminCommand("ping").ok }' \
        --quiet --authenticationDatabase admin
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - zonie-net

  # --- 4. Zonie API Server ---
  api-server:
    build:
      # (중요!) context는 이 파일 위치(infra)에서 한 단계 위(루트)
      context: ..
      dockerfile: ./api-server/Dockerfile # context 기준 경로
    container_name: zonie_api_server
    ports:
      - "8080:8080"
    environment:
      # Spring이 Docker 내부의 DB/Redis를 찾도록 설정
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_db:5432/zonie_main
      - SPRING_DATA_REDIS_HOST=redis_cache
      - SPRING_DATA_MONGODB_URI=mongodb://mongo_db:27017/zonie_chat
    depends_on: # DB/Redis가 먼저 뜨도록 설정
      postgres_db:
        condition: service_healthy
      redis_cache:
        condition: service_started
      mongo_db:
        condition: service_healthy
    networks:
      - zonie-net

  # --- 5. Zonie Chat Server ---
  chat-server:
    build:
      context: ..
      dockerfile: ./chat-server/Dockerfile
    container_name: zonie_chat_server
    ports:
      - "8081:8081" # Dockerfile의 EXPOSE와 맞춰줌
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SERVER_PORT=8081 # Spring Boot 포트 변경
      - SPRING_DATA_REDIS_HOST=redis_cache
      - SPRING_DATA_MONGODB_URI=mongodb://mongo_db:27017/zonie_chat
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_db:5432/zonie_main
    depends_on:
      postgres_db:
        condition: service_healthy
      redis_cache:
        condition: service_started
      mongo_db:
        condition: service_healthy
    networks:
      - zonie-net

  # --- 6. Zonie Batch Server ---
  batch-server:
    build:
      context: ..
      dockerfile: ./batch-server/Dockerfile # context 기준 경로
    container_name: zonie_batch_server
    environment: # Redis와 PostgreSQL만 필요, 외부 API를 노출하지 않으므로 ports 섹션 x
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_db:5432/zonie_main
      - SPRING_DATA_REDIS_HOST=redis_cache
      - SPRING_DATA_MONGODB_URI=mongodb://mongo_db:27017/zonie_chat
    depends_on:
      postgres_db:
        condition: service_healthy # PG에는 써야 하므로 Healthy
      redis_cache:
        condition: service_started # Redis에서는 읽기만 하므로 Started
      mongo_db:
        condition: service_healthy
    networks:
      - zonie-net

  # --- 7. Monitoring (Prometheus) ---
  prometheus:
    image: prom/prometheus:v2.47.2
    container_name: zonie_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../config/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml
    networks:
      - zonie-net

  # --- 8. Visualization (Grafana) ---
  grafana:
    image: grafana/grafana:10.1.5
    container_name: zonie_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - zonie-net

# --- 데이터 보존을 위한 볼륨 정의 ---
volumes:
  postgres_data:
  redis_data:
  mongo_data:
  prometheus_data:
  grafana_data: